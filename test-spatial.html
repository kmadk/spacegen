<!DOCTYPE html>
<html>
  <head>
    <title>Spatial Kernel Test</title>
    <style>
      body {
        font-family: monospace;
        padding: 20px;
        background: #f0f0f0;
      }
      #viewport-info {
        background: white;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
      }
      #canvas {
        background: white;
        padding: 20px;
        border-radius: 8px;
        min-height: 400px;
        position: relative;
        overflow: hidden;
      }
      .node {
        position: absolute;
        background: #e0e0ff;
        padding: 15px;
        border: 2px solid #8080ff;
        border-radius: 6px;
      }
    </style>
  </head>
  <body>
    <h1>ðŸ§ª Spatial Kernel Test</h1>

    <div id="viewport-info">
      <h2>Viewport Info</h2>
      <div>Position: <span id="position">0, 0</span></div>
      <div>Scale: <span id="scale">1</span></div>
      <div>Semantic Level: <span id="level">?</span></div>
      <div>
        Query:
        <pre id="query">?</pre>
      </div>
    </div>

    <div id="canvas">
      <h2>Canvas</h2>
      <div class="node" style="left: 100px; top: 50px">
        <strong>ui.frame</strong><br />
        Dashboard Container
      </div>
      <div class="node" style="left: 300px; top: 50px">
        <strong>ui.table</strong><br />
        Users Table<br />
        <span id="table-detail">5 rows</span>
      </div>
      <div class="node" style="left: 500px; top: 50px">
        <strong>ui.chart</strong><br />
        Revenue Chart<br />
        <span id="chart-detail">12 bars</span>
      </div>
    </div>

    <script type="module">
      // Import from the served spatial-kernel
      async function loadSpatialKernel() {
        try {
          // Try to load as a module
          const response = await fetch(
            "http://localhost:8080/spatial-kernel.js"
          );
          const code = await response.text();
          console.log(
            "Loaded spatial-kernel, first 200 chars:",
            code.substring(0, 200)
          );

          // Since it's CommonJS, we need to eval it differently
          const module = { exports: {} };
          const exports = module.exports;
          eval(code);
          return module.exports;
        } catch (error) {
          console.error("Failed to load spatial-kernel:", error);
          return null;
        }
      }

      async function init() {
        const SpatialKernel = await loadSpatialKernel();

        if (!SpatialKernel) {
          document.getElementById("level").textContent = "Failed to load";
          return;
        }

        console.log("SpatialKernel loaded:", SpatialKernel);

        // Create viewport
        const viewport = new SpatialKernel.Viewport(0, 0, 1);

        // Update function
        function update() {
          document.getElementById(
            "position"
          ).textContent = `${viewport.x}, ${viewport.y}`;
          document.getElementById("scale").textContent =
            viewport.scale.toFixed(2);

          const level = SpatialKernel.getSemanticLevel(viewport.scale);
          document.getElementById("level").textContent = level;

          const query = SpatialKernel.generateQuery(viewport, "test_table");
          document.getElementById("query").textContent = query.substring(
            0,
            200
          );

          // Update detail based on zoom
          if (viewport.scale < 0.5) {
            document.getElementById("table-detail").textContent =
              "1 row (summary)";
            document.getElementById("chart-detail").textContent =
              "1 bar (total)";
          } else if (viewport.scale < 2) {
            document.getElementById("table-detail").textContent = "5 rows";
            document.getElementById("chart-detail").textContent = "12 bars";
          } else {
            document.getElementById("table-detail").textContent =
              "100 rows (detailed)";
            document.getElementById("chart-detail").textContent =
              "30 bars (full)";
          }
        }

        // Initial update
        update();

        // Zoom on scroll
        document.getElementById("canvas").addEventListener("wheel", (e) => {
          e.preventDefault();
          const delta = e.deltaY > 0 ? 0.9 : 1.1;
          viewport.zoom(delta);
          update();
        });

        // Pan on drag
        let isDragging = false;
        let dragStart = { x: 0, y: 0 };

        document.getElementById("canvas").addEventListener("mousedown", (e) => {
          isDragging = true;
          dragStart = { x: e.clientX - viewport.x, y: e.clientY - viewport.y };
        });

        document.addEventListener("mousemove", (e) => {
          if (isDragging) {
            viewport.x = e.clientX - dragStart.x;
            viewport.y = e.clientY - dragStart.y;
            update();
          }
        });

        document.addEventListener("mouseup", () => {
          isDragging = false;
        });
      }

      init();
    </script>
  </body>
</html>
